<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correctional Shift Management - Cost Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK v9 (modular) -->
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563EB;
            --dark-blue: #1E40AF;
            --light-blue: #DBEAFE;
            --pain-orange: #C2410C;
            --pain-dark: #92400E;
            --bg-gray: #F8FAFC;
            --border-gray: #E2E8F0;
            --text-dark: #0F172A;
            --text-medium: #475569;
            --text-light: #94A3B8;
            --success-green: #10B981;
            --cost-red: #DC2626;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #E0E7FF 100%);
            color: var(--text-dark);
            padding: 20px;
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 32px;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--text-medium);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        .app-container {
            display: none;
            max-width: 1900px;
            margin: 0 auto;
        }

        .app-container.active {
            display: block;
        }

        /* Page Views */
        .page-view {
            display: none;
        }

        .page-view.active {
            display: block;
        }

        .back-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            cursor: pointer;
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .back-nav:hover {
            gap: 15px;
            color: var(--dark-blue);
        }

        .back-nav::before {
            content: '‚Üê';
            font-size: 24px;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .top-bar h1 {
            font-size: 28px;
            color: var(--primary-blue);
        }

        .top-bar-subtitle {
            font-size: 14px;
            color: var(--text-medium);
            font-weight: 600;
            margin-top: 5px;
        }

        .cost-badge {
            background: linear-gradient(135deg, var(--cost-red), #B91C1C);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            display: inline-block;
            margin-top: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .cost-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }

        .top-bar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            background: var(--bg-gray);
            padding: 6px;
            border-radius: 10px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--border-gray);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #CBD5E1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            background: var(--bg-gray);
            border-radius: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 40px;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 30px;
            padding: 20px 30px;
            background: var(--bg-gray);
            border-radius: 12px;
            border: 2px solid var(--border-gray);
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
        }

        .legend-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            flex-shrink: 0;
        }

        .legend-icon.person {
            background: var(--text-dark);
            color: white;
        }

        .legend-icon.action {
            background: var(--primary-blue);
            color: white;
        }

        .legend-icon.pain {
            background: var(--pain-orange);
            color: white;
        }

        /* Phase Navigation */
        .phase-nav {
            position: sticky;
            top: 0;
            z-index: 200;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
        }

        .phase-nav-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 15px;
            text-align: center;
        }

        .chevron-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            overflow-x: auto;
            padding: 10px 0;
        }

        .chevron-item {
            position: relative;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            padding: 16px 45px 16px 30px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 0 100%, 20px 50%);
            margin-left: -15px;
            z-index: 1;
            white-space: nowrap;
            flex-shrink: 0;
            text-align: center;
            border: none;
        }

        .chevron-item:first-child {
            margin-left: 0;
            clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 0 100%);
            padding-left: 30px;
        }

        .chevron-item:hover {
            transform: translateY(-3px);
            filter: brightness(1.1);
            z-index: 2;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .chevron-item.active {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            z-index: 3;
        }

        .chevron-item[data-tooltip] {
            position: relative;
        }

        .chevron-item[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: #1F2937;
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.2s ease;
            pointer-events: none;
            line-height: 1.4;
        }

        .chevron-item[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #1F2937;
            z-index: 10000;
            pointer-events: none;
        }

        .chevron-number {
            display: block;
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .chevron-label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .chevron-cost {
            display: block;
            font-size: 11px;
            opacity: 0.95;
            font-weight: 800;
            color: #FCD34D;
        }

        /* Phase Section */
        .phase-section {
            margin-bottom: 60px;
            padding: 30px;
            background: linear-gradient(to right, rgba(37, 99, 235, 0.03), rgba(219, 234, 254, 0.3));
            border-left: 5px solid var(--primary-blue);
            border-radius: 12px;
            scroll-margin-top: 180px;
        }

        .phase-header {
            margin-bottom: 30px;
        }

        .phase-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 8px;
        }

        .phase-time {
            font-size: 15px;
            color: var(--text-medium);
            font-weight: 500;
        }

        .phase-cost {
            font-size: 18px;
            color: var(--cost-red);
            font-weight: 700;
            margin-top: 8px;
        }

        /* Flow Diagram */
        .flow-diagram {
            position: relative;
            padding: 40px 20px;
            min-height: 400px;
        }

        .swimlane {
            position: relative;
            min-height: 100px;
            border-bottom: 2px dashed var(--border-gray);
            padding: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .swimlane:last-child {
            border-bottom: none;
        }

        .persona-label {
            width: 180px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
        }

        .persona-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--text-dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .persona-name {
            font-weight: 600;
            font-size: 13px;
            line-height: 1.3;
        }

        .flow-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-flow-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
            position: relative;
        }

        .action-with-pain {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .action-box {
            position: relative;
            background: white;
            border: 3px solid var(--primary-blue);
            border-radius: 10px;
            padding: 12px 18px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .action-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .flow-arrow {
            color: var(--text-medium);
            font-size: 24px;
            font-weight: 700;
            margin: 0 5px;
        }

        /* Pain Point Callout */
        .pain-callout {
            position: relative;
            background: linear-gradient(135deg, var(--pain-orange), var(--pain-dark));
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 13px;
            line-height: 1.4;
            max-width: 320px;
            box-shadow: 0 8px 24px rgba(194, 65, 12, 0.3);
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
        }

        .pain-callout:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(194, 65, 12, 0.4);
        }

        .pain-callout::before {
            content: '';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 18px solid var(--pain-orange);
            filter: drop-shadow(0 -2px 4px rgba(194, 65, 12, 0.2));
        }

        .pain-callout.above {
            margin-top: 0;
            margin-bottom: 25px;
        }

        .pain-callout.above::before {
            top: auto;
            bottom: -18px;
            border-bottom: none;
            border-top: 18px solid var(--pain-dark);
            filter: drop-shadow(0 2px 4px rgba(194, 65, 12, 0.2));
        }

        .pain-cost {
            display: block;
            font-size: 16px;
            font-weight: 800;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-icon:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        /* Citation Drawer */
        .citation-drawer {
            position: fixed;
            right: -500px;
            top: 0;
            width: 500px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .citation-drawer.open {
            right: 0;
        }

        .drawer-header {
            background: linear-gradient(135deg, var(--pain-orange), var(--pain-dark));
            color: white;
            padding: 25px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .drawer-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .drawer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .drawer-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .drawer-content {
            padding: 30px;
        }

        .drawer-section {
            margin-bottom: 30px;
        }

        .drawer-section h4 {
            color: var(--primary-blue);
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .drawer-section p {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .cost-breakdown {
            background: var(--bg-gray);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--cost-red);
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .cost-item .label {
            color: var(--text-medium);
            font-weight: 600;
        }

        .cost-item .value {
            color: var(--cost-red);
            font-weight: 700;
        }

        .citation-source {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .source-title {
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .source-excerpt {
            color: var(--text-dark);
            font-size: 13px;
            line-height: 1.6;
            font-style: italic;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-gray);
            border-left: 3px solid var(--primary-blue);
        }

        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-blue);
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .source-link:hover {
            color: var(--dark-blue);
            gap: 12px;
        }

        /* Overlay */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .drawer-overlay.active {
            display: block;
        }

        /* Edit Mode Controls */
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #EF4444;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #DC2626;
            transform: scale(1.1);
        }

        .edit-mode .delete-btn {
            display: flex;
        }

        .add-btn-inline {
            padding: 10px 20px;
            border: 2px dashed var(--border-gray);
            background: white;
            border-radius: 8px;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .edit-mode .add-btn-inline {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-btn-inline:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: var(--light-blue);
        }

        .add-flow-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--border-gray);
            background: white;
            border-radius: 10px;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            margin-top: 15px;
        }

        .edit-mode .add-flow-btn {
            display: block;
        }

        .add-flow-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: var(--light-blue);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 35px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 900px;
        }

        .breakdown-chart {
            margin: 30px 0;
        }

        .breakdown-item {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-gray);
            border-radius: 12px;
            border-left: 5px solid var(--cost-red);
            transition: all 0.3s ease;
        }

        .breakdown-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .breakdown-category {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-blue);
        }

        .breakdown-value {
            font-weight: 800;
            font-size: 18px;
            color: var(--cost-red);
        }

        .breakdown-bar {
            height: 30px;
            background: linear-gradient(90deg, var(--cost-red), #EF4444);
            border-radius: 6px;
            position: relative;
            margin: 10px 0;
        }

        .breakdown-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .breakdown-description {
            font-size: 14px;
            color: var(--text-medium);
            line-height: 1.6;
            margin-top: 8px;
        }

        .summary-box {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .summary-box h3 {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-box .big-number {
            font-size: 48px;
            font-weight: 800;
            margin: 10px 0;
        }

        .summary-box .subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: var(--primary-blue);
        }

        .close-modal {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-gray);
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-medium);
        }

        .close-modal:hover {
            background: var(--border-gray);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            margin-bottom: 15px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            border-left: 4px solid var(--success-green);
        }

        .notification.error {
            border-left: 4px solid #EF4444;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .info-box {
            background: #DBEAFE;
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-box h3 {
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .info-box p {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .info-box code {
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .swimlane {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 30px 10px;
            }

            .persona-label {
                width: 100%;
            }

            .flow-content {
                width: 100%;
                padding-left: 20px;
            }

            .pain-callout {
                position: static;
                margin: 10px 0;
            }

            .pain-callout::before {
                display: none;
            }

            .citation-drawer {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <h1>üîê Workflow Cost Analyzer</h1>
                <p>Correctional Shift Management with Overtime Cost Analysis</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="password">Access Code</label>
                    <input type="password" id="password" placeholder="Enter access code" required>
                </div>
                <button type="submit" class="login-btn">
                    Access Workflow
                </button>
                <div class="error-message" id="errorMessage">
                    ‚ùå Incorrect access code. Please try again.
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Workflow View -->
        <div class="page-view active" id="workflowView">
            <div class="top-bar">
                <div>
                    <h1>üìä Correctional Shift Management</h1>
                    <div class="top-bar-subtitle">National Overtime Cost Analysis</div>
                    <div style="display: flex; gap: 15px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                        <button class="cost-badge" onclick="showCostBreakdown('research')" id="researchBadge" title="Click to view research-based cost breakdown">
                            üí∞ Research: $2.5B+/year
                        </button>
                        <button class="cost-badge" onclick="showCostBreakdown('actual')" id="actualBadge" style="background: linear-gradient(135deg, #059669, #047857);" title="Click to view your actual cost breakdown">
                            üíµ Your Actual: <span id="actualTotal">Enter data</span>
                        </button>
                    </div>
                </div>
                <div class="top-bar-actions">
                    <div id="connectionStatus" style="display: none; padding: 8px 16px; background: var(--bg-gray); border-radius: 8px; font-size: 13px; font-weight: 600;">
                        <span id="statusIcon">üîÑ</span>
                        <span id="statusText">Connecting...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="showDebugInfo()" style="font-size: 12px; padding: 8px 16px;">
                        üîß Debug
                    </button>
                    <div class="mode-toggle">
                        <button class="mode-btn active" data-mode="view">üëÅ View</button>
                        <button class="mode-btn" data-mode="edit">‚úèÔ∏è Edit</button>
                    </div>
                    <button class="btn btn-success" id="saveChanges" style="display: none;">
                        üíæ Save Changes
                    </button>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="currentUsername">User</span>
                    </div>
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                </div>
            </div>

            <div class="main-content view-mode" id="mainContent">
                <!-- Phase Navigation -->
                <div class="phase-nav">
                    <div class="phase-nav-title">üìç Navigate to Phase</div>
                    <div class="chevron-container" id="chevronNav"></div>
                </div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-icon person">üë§</div>
                        <span>Person/Role</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon action">‚Üí</div>
                        <span>Action Flow</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon pain">üí∞</div>
                        <span>Pain Point with Cost</span>
                    </div>
                </div>

                <div id="phasesContainer"></div>
            </div>
        </div>

        <!-- Cost Breakdown View -->
        <div class="page-view" id="breakdownView">
            <div class="top-bar">
                <div>
                    <h1>üí∞ National OT Cost Breakdown</h1>
                    <div class="top-bar-subtitle">Operational Hypothesis Analysis</div>
                </div>
                <div class="top-bar-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar2">A</div>
                        <span id="currentUsername2">User</span>
                    </div>
                    <button class="btn btn-secondary" id="logoutBtn2">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="back-nav" onclick="showWorkflowView()">
                    Back to Workflow View
                </div>
                <div id="breakdownContent"></div>
            </div>
        </div>
    </div>

    <!-- Citation Drawer -->
    <div class="citation-drawer" id="citationDrawer">
        <div class="drawer-header">
            <h3>Overtime Cost Analysis</h3>
            <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <!-- Content will be dynamically populated -->
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Item</h2>
                <button class="close-modal" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" id="modalSave">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCqlGHUyXqiwKba8bZeUxuDsz8BG0v9kD8",
            authDomain: "workflow-editor-6bb0b.firebaseapp.com",
            projectId: "workflow-editor-6bb0b",
            storageBucket: "workflow-editor-6bb0b.firebasestorage.app",
            messagingSenderId: "363265686774",
            appId: "1:363265686774:web:9ebfa14d2b6dab004300d7"
        };

        // Initialize Firebase
        let db = null;
        let isFirebaseEnabled = false;
        
        // Wait for Firebase SDK to load
        function initializeFirebase() {
            try {
                // Check if Firebase SDK is loaded
                if (typeof firebase === 'undefined') {
                    console.log("‚è≥ Waiting for Firebase SDK to load...");
                    return false;
                }
                
                // Check if Firebase config is set up (not default values)
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    isFirebaseEnabled = true;
                    console.log("‚úÖ Firebase enabled - Multi-user mode active");
                    setTimeout(() => updateConnectionStatus('connected'), 1000);
                    return true;
                } else {
                    console.log("‚ö†Ô∏è Firebase not configured - Using local storage (single-user mode)");
                    setTimeout(() => updateConnectionStatus('local'), 1000);
                    return false;
                }
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                console.log("‚ö†Ô∏è Falling back to local storage");
                setTimeout(() => updateConnectionStatus('local'), 1000);
                return false;
            }
        }
        
        // Try to initialize with retries
        let firebaseInitialized = false;
        let retryCount = 0;
        const maxRetries = 5;
        
        function tryInitializeFirebase() {
            // Check if running from file:// protocol
            if (window.location.protocol === 'file:') {
                console.warn("‚ö†Ô∏è WARNING: Running from file:// protocol");
                console.warn("Firebase requires HTTP/HTTPS. Please:");
                console.warn("1. Upload to GitHub Pages, OR");
                console.warn("2. Use a local server (e.g., python -m http.server)");
                setTimeout(() => updateConnectionStatus('local'), 1000);
                return;
            }
            
            if (typeof firebase !== 'undefined') {
                firebaseInitialized = initializeFirebase();
                if (firebaseInitialized) {
                    console.log("üéâ Firebase ready!");
                }
            } else if (retryCount < maxRetries) {
                retryCount++;
                console.log(`‚è≥ Retry ${retryCount}/${maxRetries} - Waiting for Firebase SDK...`);
                setTimeout(tryInitializeFirebase, 500);
            } else {
                console.log("‚ö†Ô∏è Firebase SDK not loaded after retries");
                console.log("üí° Check:");
                console.log("   - Are you online?");
                console.log("   - Is www.gstatic.com blocked?");
                console.log("   - Check browser console for script errors");
                console.log("üìç Falling back to local storage mode");
                setTimeout(() => updateConnectionStatus('local'), 1000);
            }
        }
        
        // Start trying to initialize
        setTimeout(tryInitializeFirebase, 100);

        // ============================================
        // APPLICATION CODE
        // ============================================
        const ACCESS_CODE = 'workflow2026';
        const STORAGE_KEY = 'workflow-cost-data';
        const FIREBASE_DOC_ID = 'workflow-main'; // Single shared document for all users
        
        let workflowData = null;
        let isEditMode = false;
        let currentEditItem = null;
        let currentUser = null;

        // DEFAULT DATA WITH COST ESTIMATES AND CITATIONS
        const DEFAULT_DATA = {
            phases: [
                {
                    id: 'phase1',
                    title: 'üìã Phase 1: Pre-Shift Planning',
                    time: '5:30 AM - 6:00 AM',
                    estimatedCost: '$420M',
                    flows: [
                        {
                            persona: { name: 'Scheduling Coordinator', avatar: 'SC' },
                            actions: [
                                { text: 'Review Roster', hasPain: false },
                                { 
                                    text: 'Identify Call-Outs', 
                                    hasPain: true, 
                                    painText: 'Last-minute call-outs require emergency OT within 30-60 min',
                                    painPosition: 'above',
                                    costEstimate: '$420M',
                                    actualCost: null,
                                    costContext: 'Emergency call-out response accounts for approximately 17% of total correctional overtime costs nationwide. Based on data from multiple states, facilities average 3-5 emergency call-outs per week requiring immediate overtime coverage.',
                                    citations: [
                                        {
                                            title: 'The Marshall Project: Data Reveals Prison Crisis',
                                            excerpt: 'From 2019 to 2022, corrections staff decreased by about one-third in Georgia. During that time, the state\'s spending on overtime for prison workers ballooned to more than $4 million, more than 11 times as high as the pre-pandemic level.',
                                            url: 'https://www.themarshallproject.org/2024/01/10/prison-correctional-officer-shortage-overtime-data'
                                        },
                                        {
                                            title: 'Prison Policy Initiative: Understaffing Crisis',
                                            excerpt: 'Despite heavy investments in recruitment in New Hampshire in recent years, the department of corrections ran up a $3.4 million deficit trying to operate state prisons with roughly half its workforce.',
                                            url: 'https://www.prisonpolicy.org/blog/2024/12/09/understaffing/'
                                        }
                                    ]
                                },
                                { text: 'Check Staffing', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'Night Lieutenant', avatar: 'LT' },
                            actions: [
                                { text: 'Provide Handoff', hasPain: false },
                                { text: 'Report Incidents', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'On-Call Officers', avatar: 'CO' },
                            actions: [
                                { text: 'Contacted for OT', hasPain: false },
                                { 
                                    text: 'Respond to Call', 
                                    hasPain: true, 
                                    painText: 'Officers don\'t answer phones at 5:30 AM ‚Äì delays coverage',
                                    painPosition: 'below',
                                    costEstimate: '$180M',
                                    costContext: 'Delayed response to early morning call-outs results in extended shifts for on-duty officers and increased mandatory overtime. Estimated 7% of total OT costs attributed to delayed emergency coverage.',
                                    citations: [
                                        {
                                            title: 'Connecticut DOC Overtime Analysis',
                                            excerpt: 'The state\'s Department of Correction doled out a total of $110.8 million in overtime to correction officers in 2024 ‚Äì a 30.5% increase from 2015. Many of the extra hours are mandatory to cover required prison shifts.',
                                            url: 'https://www.corrections1.com/jail-management/mandatory-ot-16-hour-days-drive-conn-doc-overtime-past-110m'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 'phase2',
                    title: 'üì¢ Phase 2: Shift Briefing',
                    time: '5:45 AM - 6:15 AM',
                    estimatedCost: '$290M',
                    flows: [
                        {
                            persona: { name: 'Shift Sergeant', avatar: 'SS' },
                            actions: [
                                { 
                                    text: 'Conduct Briefing', 
                                    hasPain: true, 
                                    painText: 'Short-staffed = rushed briefings miss critical safety info',
                                    painPosition: 'above',
                                    costEstimate: '$150M',
                                    costContext: 'Inadequate briefings due to understaffing lead to incidents requiring supervisory overtime and emergency response. Approximately 6% of total correctional OT costs.',
                                    citations: [
                                        {
                                            title: 'Vera Institute: Price of Prisons 2015',
                                            excerpt: 'Personnel costs‚Äîincluding salaries, overtime, and benefits‚Äîcomprised the lion\'s share of state prison expenditures, making up more than two-thirds (68 percent) of total spending in 2015.',
                                            url: 'https://www.vera.org/publications/price-of-prisons-2015-state-spending-trends/price-of-prisons-2015-state-spending-trends/price-of-prisons-2015-state-spending-trends-prison-spending'
                                        }
                                    ]
                                },
                                { text: 'Announce Posts', hasPain: false },
                                { text: 'Issue Equipment', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'Correctional Officers', avatar: 'CO' },
                            actions: [
                                { text: 'Arrive & Check In', hasPain: false },
                                { 
                                    text: 'Receive Assignment', 
                                    hasPain: true, 
                                    painText: 'Officers assigned to unfamiliar posts increase OT risk',
                                    painPosition: 'below',
                                    costEstimate: '$140M',
                                    costContext: 'Officers working unfamiliar posts require additional supervisory support and extended shifts for training, contributing approximately 5-6% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'Illinois Department of Corrections Overtime Report',
                                            excerpt: 'The Illinois Department of Correction\'s staff collectively worked nearly 2 million hours of overtime during the 2022 fiscal year, costing the department $95.5 million.',
                                            url: 'https://www.prisonpolicy.org/blog/2024/12/09/understaffing/'
                                        }
                                    ]
                                },
                                { text: 'Get Equipment', hasPain: false }
                            ]
                        }
                    ]
                },
                {
                    id: 'phase3',
                    title: 'üîÑ Phase 3: Shift Handoff',
                    time: '6:00 AM - 6:30 AM',
                    estimatedCost: '$380M',
                    flows: [
                        {
                            persona: { name: 'Night Shift Officer', avatar: 'NS' },
                            actions: [
                                { 
                                    text: 'Verbal Handoff', 
                                    hasPain: true, 
                                    painText: 'Rushed handoffs = info lost, requiring supervisors to stay for OT',
                                    painPosition: 'above',
                                    costEstimate: '$200M',
                                    costContext: 'Inadequate shift handoffs require supervisory overtime to address information gaps and incidents. Represents approximately 8% of national correctional overtime spending.',
                                    citations: [
                                        {
                                            title: 'New York State Comptroller: Overtime Analysis',
                                            excerpt: 'Average annual overtime hours per Corrections employee grew 26.3% from 2023 to 325 annual overtime hours in 2024, with the increase coinciding with a workforce reduction of more than 1,000 in that year.',
                                            url: 'https://www.osc.ny.gov/press/releases/2025/07/dinapoli-state-agency-overtime-costs-increased-10.2-percent-in-2024-up-1.8m-hours-over-2023'
                                        }
                                    ]
                                },
                                { text: 'Complete Reports', hasPain: false },
                                { text: 'Turn In Keys', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'Day Shift Officer', avatar: 'DS' },
                            actions: [
                                { text: 'Receive Handoff', hasPain: false },
                                { text: 'Inspect Post', hasPain: false },
                                { 
                                    text: 'Begin Count', 
                                    hasPain: true, 
                                    painText: 'Count discrepancies lock down facility ‚Äì all officers held',
                                    painPosition: 'below',
                                    costEstimate: '$180M',
                                    costContext: 'Count discrepancies require facility-wide lockdowns and mandatory overtime for all officers until resolved. Estimated 7% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'Nebraska Corrections Overtime Audit',
                                            excerpt: 'Correctional staff were paid $22 million in overtime in 2023. Experienced correctional guards can earn over $150,000 annually in wages, overtime, and compensatory time.',
                                            url: 'https://www.corrections1.com/jail-management/neb-prison-employees-paid-22m-in-overtime-in-2023-auditor-says'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 'phase4',
                    title: '‚ö° Phase 4: Mid-Shift Operations',
                    time: '8:00 AM - 4:00 PM',
                    estimatedCost: '$625M',
                    flows: [
                        {
                            persona: { name: 'Post Officers', avatar: 'CO' },
                            actions: [
                                { text: 'Security Rounds', hasPain: false },
                                { text: 'Supervise Inmates', hasPain: false },
                                { 
                                    text: 'Process Movement', 
                                    hasPain: true, 
                                    painText: 'No spare capacity ‚Äì any incident pulls officers requiring OT',
                                    painPosition: 'above',
                                    costEstimate: '$375M',
                                    costContext: 'Operating at minimum staffing means any incident requires immediate overtime coverage. This accounts for approximately 15% of total national correctional overtime costs.',
                                    citations: [
                                        {
                                            title: 'Prison Legal News: All 50 States Report Understaffing',
                                            excerpt: 'California spent $340 million on overtime compensation in 2015. New York state prisons spent $221 million on overtime in 2017. Pennsylvania\'s Department of Corrections spent $108 million in overtime.',
                                            url: 'https://www.prisonlegalnews.org/news/2020/apr/1/all-50-states-report-prison-understaffing/'
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            persona: { name: 'Shift Sergeant', avatar: 'SS' },
                            actions: [
                                { text: 'Monitor Staffing', hasPain: false },
                                { 
                                    text: 'Coordinate Coverage', 
                                    hasPain: true, 
                                    painText: 'Officers skip breaks to maintain posts = fatigue & more OT',
                                    painPosition: 'below',
                                    costEstimate: '$250M',
                                    costContext: 'Break coverage challenges lead to officer fatigue, increased errors, and cascading overtime needs. Approximately 10% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'Rhode Island DOC Overtime Investigation',
                                            excerpt: 'A correctional officer at the ACI was the top overtime earner in fiscal year 2024, making $301,196 in overtime alone, more than tripling his $86,000 salary. The DOC had a 13% vacancy rate prompting 407 examples of involuntary mandatory overtime in just two months.',
                                            url: 'https://turnto10.com/i-team/on-your-dime/rhode-island-state-employees-clock-more-than-200000-dollars-overtime-staffing-shortages'
                                        }
                                    ]
                                },
                                { text: 'Handle Incidents', hasPain: false }
                            ]
                        }
                    ]
                },
                {
                    id: 'phase5',
                    title: 'üìä Phase 5: End-of-Shift Planning',
                    time: '4:00 PM - 6:00 PM',
                    estimatedCost: '$485M',
                    flows: [
                        {
                            persona: { name: 'Day Shift Sergeant', avatar: 'DS' },
                            actions: [
                                { text: 'Review Next Roster', hasPain: false },
                                { 
                                    text: 'Check Evening Coverage', 
                                    hasPain: true, 
                                    painText: 'Evening shift gaps discovered late = mandatory OT holds',
                                    painPosition: 'above',
                                    costEstimate: '$310M',
                                    costContext: 'Late discovery of evening shift vacancies leads to mandatory overtime holds for day shift officers. Approximately 12% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'Maryland Corrections Staffing Crisis',
                                            excerpt: 'Maryland\'s prisons are facing a staffing crisis with a shortage of about 1,000 officers, about 20% of positions. The state paid $129 million in overtime to prison guards in 2019 and expects to pay $150 million in overtime.',
                                            url: 'https://www.prisonlegalnews.org/news/2020/apr/1/all-50-states-report-prison-understaffing/'
                                        }
                                    ]
                                },
                                { text: 'Coordinate Handoff', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'Officers', avatar: 'CO' },
                            actions: [
                                { text: 'Complete Documentation', hasPain: false },
                                { 
                                    text: 'Prepare for End of Shift', 
                                    hasPain: true, 
                                    painText: 'Officers learn at 5 PM they must stay 4-8 more hours',
                                    painPosition: 'below',
                                    costEstimate: '$175M',
                                    costContext: 'Last-minute mandatory overtime notifications are the leading cause of officer burnout and turnover, perpetuating the staffing crisis. Approximately 7% of total OT costs.',
                                    citations: [
                                        {
                                            title: 'The Corrections Wellness Crisis Report',
                                            excerpt: 'One state agency analysis found that the cost of replacing correctional officers due to turnover exceeded $16 million annually. When staffing levels stabilize, the need for expensive mandatory overtime decreases.',
                                            url: 'https://www.benchmarkanalytics.com/blog/the-corrections-wellness-crisis-the-case-for-investing-in-officer-support-solutions/'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 'phase6',
                    title: 'üåô Phase 6: Evening Shift Change',
                    time: '6:00 PM - 6:30 PM',
                    estimatedCost: '$320M',
                    flows: [
                        {
                            persona: { name: 'Day Shift Officers', avatar: 'DS' },
                            actions: [
                                { 
                                    text: 'Final Handoff', 
                                    hasPain: true, 
                                    painText: 'Officers on hour 12-16 are exhausted & error-prone',
                                    painPosition: 'above',
                                    costEstimate: '$190M',
                                    costContext: 'Officer fatigue after extended shifts leads to errors requiring additional supervisory overtime and incident response. Approximately 7-8% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'DOJ Inspector General Report on BOP Staffing',
                                            excerpt: 'The use of augmentation and mandatory overtime to compensate for staffing shortages overburdened employees and may have contributed to staff fatigue, sleep deprivation, decreased vigilance and inattentiveness to duty.',
                                            url: 'https://www.shaheen.senate.gov/news/press/new-senators-shaheen-and-mccormick-introduce-bipartisan-bicameral-legislation-to-address-chronic-staffing-shortages-at-federal-prisons'
                                        }
                                    ]
                                },
                                { text: 'Turn In Equipment', hasPain: false }
                            ]
                        },
                        {
                            persona: { name: 'Evening Shift', avatar: 'ES' },
                            actions: [
                                { text: 'Arrive for Shift', hasPain: false },
                                { text: 'Receive Briefing', hasPain: false },
                                { 
                                    text: 'Begin Posts', 
                                    hasPain: true, 
                                    painText: 'Evening shift chronically understaffed = immediate OT need',
                                    painPosition: 'below',
                                    costEstimate: '$130M',
                                    costContext: 'Evening shifts historically have highest vacancy rates, requiring continuous overtime to maintain minimum staffing. Approximately 5% of total overtime costs.',
                                    citations: [
                                        {
                                            title: 'Governing Magazine: Corrections Staffing Crisis',
                                            excerpt: 'Nearly 34 percent of staff positions are vacant in North Carolina prisons. America\'s prisons may be succeeding at keeping incarcerated people inside, but they are increasingly also keeping out the people needed to run them effectively.',
                                            url: 'https://www.governing.com/work/to-address-the-corrections-staffing-crisis-think-outside-the-cell'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ],
            metadata: {
                totalEstimatedCost: '$2.5B+',
                costBasis: 'National estimates based on 2023-2024 state corrections overtime data from multiple sources including Vera Institute, Marshall Project, Prison Policy Initiative, and state audit reports.',
                lastUpdated: new Date().toISOString()
            }
        };

        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            if (!statusDiv) return;
            
            statusDiv.style.display = 'flex';
            statusDiv.style.alignItems = 'center';
            statusDiv.style.gap = '8px';
            
            if (status === 'connected') {
                statusIcon.textContent = 'üåê';
                statusText.textContent = 'Multi-User Mode';
                statusDiv.style.color = 'var(--success-green)';
                statusDiv.style.background = '#D1FAE5';
            } else if (status === 'local') {
                statusIcon.textContent = 'üíæ';
                statusText.textContent = 'Local Mode';
                statusDiv.style.color = 'var(--text-medium)';
                statusDiv.style.background = 'var(--bg-gray)';
            } else {
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = 'Connection Issue';
                statusDiv.style.color = '#DC2626';
                statusDiv.style.background = '#FEE2E2';
            }
        }

        async function showDebugInfo() {
            const info = {
                firebaseEnabled: isFirebaseEnabled,
                apiKeyConfigured: firebaseConfig.apiKey !== "YOUR_API_KEY",
                hasDatabase: db !== null,
                currentUser: currentUser,
                workflowDataSize: JSON.stringify(workflowData).length
            };

            let firestoreStatus = 'Not configured';
            if (isFirebaseEnabled && db) {
                try {
                    const docRef = db.collection('workflows').doc(FIREBASE_DOC_ID);
                    const doc = await docRef.get();
                    firestoreStatus = doc.exists ? '‚úÖ Document exists' : '‚ö†Ô∏è Document not found';
                    info.lastUpdate = doc.exists ? doc.data().lastUpdated : null;
                    info.lastUpdatedBy = doc.exists ? doc.data().lastUpdatedBy : null;
                } catch (error) {
                    firestoreStatus = '‚ùå Error: ' + error.message;
                }
            }
            info.firestoreStatus = firestoreStatus;

            alert(`üîß Debug Information:\n\n` +
                `Firebase Enabled: ${info.firebaseEnabled}\n` +
                `API Key Configured: ${info.apiKeyConfigured}\n` +
                `Database Connection: ${info.hasDatabase}\n` +
                `Firestore Status: ${info.firestoreStatus}\n` +
                `Current User: ${info.currentUser}\n` +
                `Data Size: ${info.workflowDataSize} bytes\n` +
                `Last Updated: ${info.lastUpdate || 'Never'}\n` +
                `Last Updated By: ${info.lastUpdatedBy || 'N/A'}\n\n` +
                `Check browser console (F12) for detailed logs.`
            );
            console.log('üîß Full Debug Info:', info);
        }

        function init() {
            // Ensure Firebase is initialized
            if (!firebaseInitialized && typeof firebase !== 'undefined') {
                initializeFirebase();
            }
            setupEventListeners();
            loadWorkflowData();
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('logoutBtn2').addEventListener('click', handleLogout);
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleMode(btn.dataset.mode));
            });

            document.getElementById('saveChanges').addEventListener('click', saveWorkflowData);
            document.getElementById('modalSave').addEventListener('click', saveModalEdit);
        }

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');

            if (password === ACCESS_CODE) {
                currentUser = 'Team User';
                const initial = 'TU';
                document.getElementById('currentUsername').textContent = 'Team User';
                document.getElementById('currentUsername2').textContent = 'Team User';
                document.getElementById('userAvatar').textContent = initial;
                document.getElementById('userAvatar2').textContent = initial;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                showNotification('Welcome! Loading shared data...', 'success');
            } else {
                errorMsg.textContent = '‚ùå Incorrect access code';
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 3000);
            }
        }

        function handleLogout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('password').value = '';
            currentUser = null;
            isEditMode = false;
        }

        function loadWorkflowData() {
            if (isFirebaseEnabled) {
                loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
        }

        async function loadFromFirebase() {
            try {
                showNotification('Loading shared data...', 'success');
                const docRef = db.collection('workflows').doc(FIREBASE_DOC_ID);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    workflowData = doc.data().workflow;
                    console.log('‚úÖ Loaded data from Firebase');
                } else {
                    // First time - initialize with default data
                    workflowData = DEFAULT_DATA;
                    await saveToFirebase();
                    console.log('‚úÖ Initialized Firebase with default data');
                }
                
                renderWorkflow();
                updateActualCostTotal();
                
                // Set up real-time listener for changes from other users
                let isOwnSave = false;
                window.setOwnSaveFlag = () => { isOwnSave = true; };
                
                docRef.onSnapshot((doc) => {
                    if (doc.exists && !isOwnSave) {
                        const newData = doc.data().workflow;
                        // Update if data changed
                        const newDataStr = JSON.stringify(newData);
                        const currentDataStr = JSON.stringify(workflowData);
                        
                        if (newDataStr !== currentDataStr) {
                            console.log('üì• Received update from another user');
                            workflowData = newData;
                            renderWorkflow();
                            updateActualCostTotal();
                            showNotification('üì• Data updated by another user', 'success');
                        }
                    }
                    isOwnSave = false; // Reset flag
                });
                
            } catch (error) {
                console.error('Firebase load error:', error);
                showNotification('Error loading shared data, using local backup', 'error');
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                workflowData = saved ? JSON.parse(saved) : DEFAULT_DATA;
            } catch (e) {
                workflowData = DEFAULT_DATA;
            }
            renderWorkflow();
            updateActualCostTotal();
        }

        function saveWorkflowData() {
            if (isFirebaseEnabled) {
                saveToFirebase();
            } else {
                saveToLocalStorage();
            }
        }

        async function saveToFirebase() {
            try {
                if (window.setOwnSaveFlag) window.setOwnSaveFlag();
                
                const docRef = db.collection('workflows').doc(FIREBASE_DOC_ID);
                await docRef.set({
                    workflow: workflowData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdatedBy: currentUser || 'Unknown'
                });
                
                // Also save to localStorage as backup
                localStorage.setItem(STORAGE_KEY, JSON.stringify(workflowData));
                
                updateActualCostTotal();
                showNotification('‚úÖ Changes saved and synced!', 'success');
                console.log('üì§ Saved to Firebase successfully');
            } catch (error) {
                console.error('‚ùå Firebase save error:', error);
                showNotification('‚ö†Ô∏è Error syncing to cloud, saved locally only', 'error');
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(workflowData));
                updateActualCostTotal();
                showNotification('Changes saved locally!', 'success');
            } catch (e) {
                showNotification('Error saving changes', 'error');
            }
        }

        function toggleMode(mode) {
            isEditMode = (mode === 'edit');
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const mainContent = document.getElementById('mainContent');
            mainContent.classList.toggle('view-mode', !isEditMode);
            mainContent.classList.toggle('edit-mode', isEditMode);

            document.getElementById('saveChanges').style.display = isEditMode ? 'block' : 'none';
        }

        function updateActualCostTotal() {
            const actualCosts = calculateActualCostsByCategory();
            const total = Object.values(actualCosts.totals).reduce((sum, val) => sum + val, 0);
            
            const badge = document.getElementById('actualTotal');
            if (total === 0) {
                badge.textContent = 'Enter data';
                badge.parentElement.style.opacity = '0.7';
            } else {
                badge.textContent = formatCost(total);
                badge.parentElement.style.opacity = '1';
            }
        }

        function renderWorkflow() {
            const container = document.getElementById('phasesContainer');
            container.innerHTML = '';

            renderChevronNav();

            workflowData.phases.forEach((phase, phaseIndex) => {
                const phaseEl = createPhaseElement(phase, phaseIndex);
                container.appendChild(phaseEl);
            });

            updateActiveChevronOnScroll();
            updateActualCostTotal();
        }

        function renderChevronNav() {
            const chevronNav = document.getElementById('chevronNav');
            chevronNav.innerHTML = '';

            workflowData.phases.forEach((phase, index) => {
                const chevron = document.createElement('button');
                chevron.className = 'chevron-item';
                chevron.setAttribute('data-phase', index);
                chevron.setAttribute('data-tooltip', phase.title);
                
                const titleParts = phase.title.match(/Phase (\d+):?\s*(.+)/);
                const phaseNum = titleParts ? titleParts[1] : (index + 1);
                const phaseName = titleParts ? titleParts[2].replace(/^üìã|üì¢|üîÑ|‚ö°|üìä|üåô\s*/, '') : phase.title;
                
                chevron.innerHTML = `
                    <span class="chevron-number">Phase ${phaseNum}</span>
                    <span class="chevron-label">${phaseName.length > 15 ? phaseName.substring(0, 15) + '...' : phaseName}</span>
                    <span class="chevron-cost">${phase.estimatedCost}</span>
                `;
                
                chevron.addEventListener('click', () => scrollToPhase(index));
                chevronNav.appendChild(chevron);
            });

            if (chevronNav.firstChild) {
                chevronNav.firstChild.classList.add('active');
            }
        }

        function scrollToPhase(phaseIndex) {
            const phaseSections = document.querySelectorAll('.phase-section');
            if (phaseSections[phaseIndex]) {
                // Update active chevron immediately on click
                updateActiveChevron(phaseIndex);
                
                phaseSections[phaseIndex].scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function updateActiveChevron(activeIndex) {
            const chevrons = document.querySelectorAll('.chevron-item');
            chevrons.forEach((chevron, index) => {
                chevron.classList.toggle('active', index === activeIndex);
            });
        }

        function updateActiveChevronOnScroll() {
            const phaseSections = document.querySelectorAll('.phase-section');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                        const phaseIndex = Array.from(phaseSections).indexOf(entry.target);
                        updateActiveChevron(phaseIndex);
                    }
                });
            }, {
                threshold: [0.3],
                rootMargin: '-100px 0px -50% 0px'
            });

            phaseSections.forEach(section => observer.observe(section));
        }

        function createPhaseElement(phase, phaseIndex) {
            const section = document.createElement('div');
            section.className = 'phase-section';
            section.id = `phase-${phaseIndex}`;
            
            let flowsHTML = '';
            phase.flows.forEach((flow, flowIndex) => {
                const actionsHTML = flow.actions.map((actionObj, actionIndex) => {
                    const isLast = actionIndex === flow.actions.length - 1;
                    
                    let painHTML = '';
                    if (actionObj.hasPain) {
                        painHTML = `
                            <div class="pain-callout ${actionObj.painPosition}" 
                                 onclick="openDrawer(${phaseIndex}, ${flowIndex}, ${actionIndex})">
                                ${actionObj.painText}
                                <span class="pain-cost">${actionObj.costEstimate} / year</span>
                                <span class="info-icon">‚Ñπ</span>
                                <button class="delete-btn" onclick="event.stopPropagation(); deletePainPoint(${phaseIndex}, ${flowIndex}, ${actionIndex})">‚úï</button>
                            </div>
                        `;
                    }

                    return `
                        <div class="action-with-pain">
                            ${actionObj.painPosition === 'above' && actionObj.hasPain ? painHTML : ''}
                            ${!actionObj.hasPain ? `
                                <button class="add-btn-inline" 
                                        onclick="addPainPoint(${phaseIndex}, ${flowIndex}, ${actionIndex}, 'above')"
                                        style="margin-bottom: 10px;">
                                    + Pain Point
                                </button>
                            ` : ''}
                            <div class="action-box" onclick="editAction(${phaseIndex}, ${flowIndex}, ${actionIndex})">
                                ${actionObj.text}
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteAction(${phaseIndex}, ${flowIndex}, ${actionIndex})">‚úï</button>
                            </div>
                            ${actionObj.painPosition === 'below' && actionObj.hasPain ? painHTML : ''}
                            ${!actionObj.hasPain ? `
                                <button class="add-btn-inline" 
                                        onclick="addPainPoint(${phaseIndex}, ${flowIndex}, ${actionIndex}, 'below')"
                                        style="margin-top: 10px;">
                                    + Pain Point
                                </button>
                            ` : ''}
                        </div>
                        ${!isLast ? '<span class="flow-arrow">‚Üí</span>' : ''}
                    `;
                }).join('');

                flowsHTML += `
                    <div class="swimlane">
                        <div class="persona-label">
                            <div class="persona-avatar-small">${flow.persona.avatar}</div>
                            <div class="persona-name">${flow.persona.name}</div>
                            <button class="delete-btn" onclick="deletePersona(${phaseIndex}, ${flowIndex})">‚úï</button>
                        </div>
                        <div class="flow-content">
                            <div class="action-flow-row">
                                ${actionsHTML}
                                <button class="add-btn-inline" onclick="addAction(${phaseIndex}, ${flowIndex})">
                                    + Action
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            section.innerHTML = `
                <div class="phase-header">
                    <div class="phase-title">${phase.title}</div>
                    <div class="phase-time">${phase.time}</div>
                    <div class="phase-cost">üí∞ Estimated OT Cost: ${phase.estimatedCost}/year</div>
                </div>
                <div class="flow-diagram">
                    ${flowsHTML}
                    <button class="add-flow-btn" onclick="addPersona(${phaseIndex})">
                        ‚ûï Add Person/Role
                    </button>
                </div>
            `;
            
            return section;
        }

        function openDrawer(phaseIndex, flowIndex, actionIndex) {
            const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
            
            if (!action.hasPain) return;

            // Initialize actualCost if not present
            if (action.actualCost === undefined) {
                action.actualCost = null;
            }

            const drawerContent = document.getElementById('drawerContent');
            
            let citationsHTML = '';
            if (action.citations && action.citations.length > 0) {
                citationsHTML = action.citations.map(citation => `
                    <div class="citation-source">
                        <div class="source-title">${citation.title}</div>
                        <div class="source-excerpt">"${citation.excerpt}"</div>
                        <a href="${citation.url}" target="_blank" class="source-link">
                            Read Full Source ‚Üí
                        </a>
                    </div>
                `).join('');
            }

            const actualCostDisplay = action.actualCost 
                ? `<span class="value">${action.actualCost}</span>`
                : `<span class="value" style="color: var(--text-light); font-style: italic;">Not entered</span>`;

            const editButton = isEditMode 
                ? `<button class="btn btn-secondary" onclick="editActualCost(${phaseIndex}, ${flowIndex}, ${actionIndex})" style="margin-top: 15px; width: 100%;">
                    ‚úèÔ∏è Enter Actual Cost Data
                   </button>`
                : '';

            drawerContent.innerHTML = `
                <div class="drawer-section">
                    <h4>Pain Point</h4>
                    <p><strong>${action.painText}</strong></p>
                </div>

                <div class="drawer-section">
                    <h4>Cost Analysis</h4>
                    <div class="cost-breakdown">
                        <div class="cost-item">
                            <span class="label">Research Estimate (National):</span>
                            <span class="value">${action.costEstimate}</span>
                        </div>
                        <div class="cost-item">
                            <span class="label">Your Actual Cost:</span>
                            ${actualCostDisplay}
                        </div>
                        <div class="cost-item">
                            <span class="label">% of Total Nat'l OT:</span>
                            <span class="value">${calculatePercentage(action.costEstimate)}%</span>
                        </div>
                    </div>
                    ${editButton}
                </div>

                <div class="drawer-section">
                    <h4>Context</h4>
                    <p>${action.costContext}</p>
                </div>

                <div class="drawer-section">
                    <h4>Research Sources</h4>
                    ${citationsHTML}
                </div>
            `;

            document.getElementById('citationDrawer').classList.add('open');
            document.getElementById('drawerOverlay').classList.add('active');
        }

        function closeDrawer() {
            document.getElementById('citationDrawer').classList.remove('open');
            document.getElementById('drawerOverlay').classList.remove('active');
        }

        function editActualCost(phaseIndex, flowIndex, actionIndex) {
            const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
            
            currentEditItem = { type: 'actualCost', phaseIndex, flowIndex, actionIndex };
            document.getElementById('modalTitle').textContent = 'Enter Actual Cost Data';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Your Actual Annual Cost</label>
                    <input type="text" id="actualCostInput" value="${action.actualCost || ''}" placeholder="e.g., $50000 or $50K">
                    <p style="font-size: 12px; color: var(--text-medium); margin-top: 8px;">
                        Enter the actual cost you've calculated for this pain point at your facility/system.
                        Format: $X or $XK or $XM
                    </p>
                </div>
                <div style="background: var(--light-blue); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--primary-blue); margin-bottom: 8px;">
                        üí° Research Estimate: ${action.costEstimate} (National)
                    </div>
                    <div style="font-size: 12px; color: var(--text-medium); line-height: 1.5;">
                        ${action.painText}
                    </div>
                </div>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        function calculatePercentage(costEstimate) {
            // Extract number from cost estimate (e.g., "$420M" -> 420)
            const value = parseFloat(costEstimate.replace(/[$M]/g, ''));
            // Total is $2.5B = 2500M
            return ((value / 2500) * 100).toFixed(1);
        }

        function editAction(phaseIndex, flowIndex, actionIndex) {
            if (!isEditMode) return;
            
            currentEditItem = { type: 'action', phaseIndex, flowIndex, actionIndex };
            const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
            
            document.getElementById('modalTitle').textContent = 'Edit Action';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Action Description</label>
                    <input type="text" id="modalInput" value="${action.text}">
                </div>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        function deleteAction(phaseIndex, flowIndex, actionIndex) {
            if (!isEditMode) return;
            if (!confirm('Delete this action?')) return;
            
            workflowData.phases[phaseIndex].flows[flowIndex].actions.splice(actionIndex, 1);
            renderWorkflow();
            showNotification('Action deleted', 'success');
        }

        function addAction(phaseIndex, flowIndex) {
            if (!isEditMode) return;
            
            currentEditItem = { type: 'newAction', phaseIndex, flowIndex };
            document.getElementById('modalTitle').textContent = 'Add Action';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Action Description</label>
                    <input type="text" id="modalInput" value="">
                </div>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        function deletePainPoint(phaseIndex, flowIndex, actionIndex) {
            if (!isEditMode) return;
            if (!confirm('Delete this pain point?')) return;
            
            const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
            action.hasPain = false;
            action.painText = '';
            action.painPosition = '';
            action.costEstimate = '';
            action.costContext = '';
            action.citations = [];
            
            renderWorkflow();
            showNotification('Pain point deleted', 'success');
        }

        function addPainPoint(phaseIndex, flowIndex, actionIndex, position) {
            if (!isEditMode) return;
            
            currentEditItem = { type: 'newPain', phaseIndex, flowIndex, actionIndex, position };
            document.getElementById('modalTitle').textContent = 'Add Pain Point';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Pain Point Description</label>
                    <textarea id="painText" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Cost Type</label>
                    <select id="costType" style="width: 100%; padding: 14px; border: 2px solid var(--border-gray); border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 14px; margin-bottom: 15px;">
                        <option value="">Select cost type...</option>
                        <option value="estimate">Research Estimate (National extrapolation)</option>
                        <option value="actual">Your Actual Cost (Facility/system data)</option>
                    </select>
                    <p style="font-size: 12px; color: var(--text-medium); margin-top: 8px;">
                        <strong>Research Estimate:</strong> Use when entering a cost based on national research/extrapolation<br>
                        <strong>Your Actual:</strong> Use when entering your facility's real calculated cost
                    </p>
                </div>
                
                <div class="form-group" id="costInputGroup" style="display: none;">
                    <label id="costLabel">Cost Amount</label>
                    <input type="text" id="costAmount" placeholder="e.g., $50000 or $50K or $50M">
                </div>
                
                <div class="form-group">
                    <label>Cost Context / Notes</label>
                    <textarea id="costContext" rows="4" placeholder="Describe why this pain point drives overtime costs..."></textarea>
                </div>
            `;
            
            // Show/hide and update cost input based on selection
            document.getElementById('costType').addEventListener('change', function() {
                const costInputGroup = document.getElementById('costInputGroup');
                const costLabel = document.getElementById('costLabel');
                
                if (this.value) {
                    costInputGroup.style.display = 'block';
                    if (this.value === 'estimate') {
                        costLabel.textContent = 'Research Estimate (National)';
                    } else {
                        costLabel.textContent = 'Your Actual Cost';
                    }
                } else {
                    costInputGroup.style.display = 'none';
                }
            });
            
            document.getElementById('editModal').classList.add('active');
        }

        function deletePersona(phaseIndex, flowIndex) {
            if (!isEditMode) return;
            if (!confirm('Delete this person/role and all their actions?')) return;
            
            workflowData.phases[phaseIndex].flows.splice(flowIndex, 1);
            renderWorkflow();
            showNotification('Person/role deleted', 'success');
        }

        function addPersona(phaseIndex) {
            if (!isEditMode) return;
            
            currentEditItem = { type: 'newPersona', phaseIndex };
            document.getElementById('modalTitle').textContent = 'Add Person/Role';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Person/Role Name</label>
                    <input type="text" id="modalInput" value="">
                </div>
            `;
            document.getElementById('editModal').classList.add('active');
        }

        function saveModalEdit() {
            const { type, phaseIndex, flowIndex, actionIndex, position } = currentEditItem;

            if (type === 'action') {
                const value = document.getElementById('modalInput').value.trim();
                if (!value) return;
                const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
                action.text = value;
            } 
            else if (type === 'newAction') {
                const value = document.getElementById('modalInput').value.trim();
                if (!value) return;
                workflowData.phases[phaseIndex].flows[flowIndex].actions.push({
                    text: value,
                    hasPain: false
                });
            }
            else if (type === 'newPain') {
                const painText = document.getElementById('painText').value.trim();
                const costType = document.getElementById('costType').value;
                const costAmount = document.getElementById('costAmount').value.trim();
                const costContext = document.getElementById('costContext').value.trim();
                
                if (!painText) {
                    showNotification('Please enter a pain point description', 'error');
                    return;
                }
                
                if (!costType) {
                    showNotification('Please select a cost type', 'error');
                    return;
                }
                
                const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
                action.painText = painText;
                action.hasPain = true;
                action.painPosition = position;
                action.costContext = costContext || 'No context provided.';
                action.citations = [];
                
                // Set either costEstimate or actualCost based on selection
                if (costType === 'estimate') {
                    action.costEstimate = costAmount || '$0M';
                    action.actualCost = null;
                } else if (costType === 'actual') {
                    action.costEstimate = '$0M'; // Default to $0M for research when user enters actual
                    action.actualCost = costAmount || null;
                }
            }
            else if (type === 'actualCost') {
                const value = document.getElementById('actualCostInput').value.trim();
                const action = workflowData.phases[phaseIndex].flows[flowIndex].actions[actionIndex];
                action.actualCost = value || null;
                
                // Update the actual cost total immediately
                updateActualCostTotal();
                
                // Reopen the drawer to show updated cost
                closeModal();
                openDrawer(phaseIndex, flowIndex, actionIndex);
                showNotification('Actual cost updated', 'success');
                return; // Don't render workflow, just update drawer
            }
            else if (type === 'newPersona') {
                const value = document.getElementById('modalInput').value.trim();
                if (!value) return;
                const initials = value.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
                workflowData.phases[phaseIndex].flows.push({
                    persona: { name: value, avatar: initials },
                    actions: [
                        { text: 'New Action', hasPain: false }
                    ]
                });
            }

            closeModal();
            renderWorkflow();
            showNotification('Changes applied', 'success');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditItem = null;
        }

        function showCostBreakdown(mode = 'research') {
            const isActual = mode === 'actual';
            
            // Calculate actual costs if in actual mode
            if (isActual) {
                const actualCosts = calculateActualCostsByCategory();
                displayActualCostBreakdown(actualCosts);
            } else {
                displayResearchCostBreakdown();
            }
        }

        function calculateActualCostsByCategory() {
            const categoryTotals = {
                'Inadequate Data & Tooling': 0,
                'Compliance Issues': 0,
                'Event Driven OT': 0,
                'Structural Understaffing': 0,
                'Training & Readiness Gaps': 0,
                'Oversight & Leakage': 0
            };

            const painPointsPerCategory = {
                'Inadequate Data & Tooling': [],
                'Compliance Issues': [],
                'Event Driven OT': [],
                'Structural Understaffing': [],
                'Training & Readiness Gaps': [],
                'Oversight & Leakage': []
            };

            // Map pain points to categories and sum actual costs
            workflowData.phases.forEach(phase => {
                phase.flows.forEach(flow => {
                    flow.actions.forEach(action => {
                        if (action.hasPain && action.actualCost) {
                            const cost = parseCost(action.actualCost);
                            const painText = action.painText.toLowerCase();
                            
                            // Categorize based on pain point text
                            if (painText.includes('call-out') || painText.includes('answer phone') || painText.includes('call-in')) {
                                categoryTotals['Inadequate Data & Tooling'] += cost;
                                painPointsPerCategory['Inadequate Data & Tooling'].push({text: action.painText, cost: action.actualCost});
                            } else if (painText.includes('mandatory ot') || painText.includes('late discovery') || painText.includes('fairness') || painText.includes('meta staffing')) {
                                categoryTotals['Compliance Issues'] += cost;
                                painPointsPerCategory['Compliance Issues'].push({text: action.painText, cost: action.actualCost});
                            } else if (painText.includes('handoff') || painText.includes('count') || painText.includes('incident')) {
                                categoryTotals['Event Driven OT'] += cost;
                                painPointsPerCategory['Event Driven OT'].push({text: action.painText, cost: action.actualCost});
                            } else if (painText.includes('no spare') || painText.includes('evening shift') || painText.includes('vacancy') || painText.includes('skip break')) {
                                categoryTotals['Structural Understaffing'] += cost;
                                painPointsPerCategory['Structural Understaffing'].push({text: action.painText, cost: action.actualCost});
                            } else if (painText.includes('briefing') || painText.includes('unfamiliar post') || painText.includes('academy')) {
                                categoryTotals['Training & Readiness Gaps'] += cost;
                                painPointsPerCategory['Training & Readiness Gaps'].push({text: action.painText, cost: action.actualCost});
                            } else {
                                categoryTotals['Oversight & Leakage'] += cost;
                                painPointsPerCategory['Oversight & Leakage'].push({text: action.painText, cost: action.actualCost});
                            }
                        }
                    });
                });
            });

            return {totals: categoryTotals, painPoints: painPointsPerCategory};
        }

        function parseCost(costString) {
            if (!costString) return 0;
            const cleaned = costString.replace(/[$,]/g, '').toUpperCase();
            let value = parseFloat(cleaned);
            if (cleaned.includes('K')) value *= 1000;
            if (cleaned.includes('M')) value *= 1000000;
            return value;
        }

        function formatCost(value) {
            if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return '$' + (value / 1000).toFixed(1) + 'K';
            return '$' + value.toLocaleString();
        }

        function displayActualCostBreakdown(actualCosts) {
            const breakdownContent = document.getElementById('breakdownContent');
            const total = Object.values(actualCosts.totals).reduce((sum, val) => sum + val, 0);

            if (total === 0) {
                breakdownContent.innerHTML = `
                    <div class="summary-box">
                        <h3>Your Actual Overtime Costs</h3>
                        <div class="big-number">No Data Yet</div>
                        <div class="subtitle">Enter actual cost data in edit mode to see your calculated totals</div>
                    </div>

                    <div style="padding: 30px; text-align: center;">
                        <p style="font-size: 16px; color: var(--text-medium); margin-bottom: 20px;">
                            üìù To enter actual cost data:
                        </p>
                        <ol style="text-align: left; max-width: 500px; margin: 0 auto; line-height: 2;">
                            <li>Toggle to <strong>Edit Mode</strong></li>
                            <li>Click the <strong>‚ÑπÔ∏è icon</strong> on any pain point</li>
                            <li>Click <strong>"Enter Actual Cost Data"</strong></li>
                            <li>Enter your facility/system's actual cost for that pain point</li>
                        </ol>
                    </div>
                `;
                // Navigate to breakdown view
                document.getElementById('workflowView').classList.remove('active');
                document.getElementById('breakdownView').classList.add('active');
                window.scrollTo(0, 0);
                return;
            }

            let categoryHTML = '';
            Object.entries(actualCosts.totals).forEach(([name, cost]) => {
                if (cost === 0) return; // Skip categories with no data
                
                const percentage = ((cost / total) * 100).toFixed(1);
                const barWidth = percentage;
                const painPoints = actualCosts.painPoints[name];
                
                categoryHTML += `
                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <span class="breakdown-category">${name}</span>
                            <span class="breakdown-value">${formatCost(cost)}</span>
                        </div>
                        <div class="breakdown-bar" style="width: ${barWidth}%">
                            <span class="breakdown-percentage">${percentage}%</span>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-gray);">
                            <div style="font-size: 12px; font-weight: 700; color: var(--cost-red); margin-bottom: 6px;">YOUR PAIN POINTS:</div>
                            <div style="font-size: 12px; color: var(--text-medium);">
                                ${painPoints.map(pp => `${pp.text} (${pp.cost})`).join(' ‚Ä¢ ')}
                            </div>
                        </div>
                    </div>
                `;
            });

            breakdownContent.innerHTML = `
                <div class="summary-box" style="background: linear-gradient(135deg, #059669, #047857);">
                    <h3>Your Actual Overtime Costs</h3>
                    <div class="big-number">${formatCost(total)}</div>
                    <div class="subtitle">Based on your facility/system data</div>
                </div>

                <h3 style="margin-bottom: 20px; color: var(--primary-blue);">Your Cost Breakdown</h3>
                ${categoryHTML}

                <div style="margin-top: 20px; padding: 20px; background: #FEF3C7; border-radius: 12px; border-left: 4px solid #F59E0B;">
                    <h4 style="color: #92400E; margin-bottom: 10px;">üí° Note</h4>
                    <p style="font-size: 14px; line-height: 1.6; color: var(--text-dark);">
                        This represents YOUR calculated costs based on the pain point data you've entered. 
                        Compare this with the national research estimates (üí∞ Research badge) to validate your assumptions.
                    </p>
                </div>
            `;

            // Navigate to breakdown view
            document.getElementById('workflowView').classList.remove('active');
            document.getElementById('breakdownView').classList.add('active');
            window.scrollTo(0, 0);
        }

        function displayResearchCostBreakdown() {
            // Aggregate costs by operational hypothesis categories
            const categories = {
                'Inadequate Data & Tooling': {
                    cost: 600,
                    description: 'Poor call-in systems, inability to reach on-call officers, and lack of real-time visibility into who is actually available force reliance on emergency overtime.',
                    painPoints: ['Last-minute call-outs requiring emergency response ($420M)', 'Officers don\'t answer phones delaying coverage ($180M)'],
                    drivers: ['Call-in policy mechanics', 'Predictable call-outs', 'Operational vs. reported vacancy']
                },
                'Compliance Issues': {
                    cost: 485,
                    description: 'Not following meta staffing patterns and fairness protocols leads to last-minute mandatory overtime assignments and poor planning for predictable gaps.',
                    painPoints: ['Last-minute mandatory OT notifications ($175M)', 'Late discovery of evening shift gaps ($310M)'],
                    drivers: ['Meta staffing pattern not followed', 'Captains don\'t use "best next person" fairness lists']
                },
                'Event Driven OT': {
                    cost: 440,
                    description: 'Dynamic incidents and operational failures (handoff errors, count discrepancies, fatigue-induced mistakes) require supervisory intervention and emergency coverage.',
                    painPoints: ['Rushed handoffs losing information ($200M)', 'Count discrepancy lockdowns ($180M)', 'Officer fatigue errors after 12-16 hour shifts ($60M)'],
                    drivers: ['Incidence driven issues', 'Handoff failures', 'Safety incidents']
                },
                'Structural Understaffing': {
                    cost: 420,
                    description: 'Operating at minimum staffing with no buffer capacity plus chronic vacancies. Every unplanned absence or additional need immediately triggers overtime.',
                    painPoints: ['No spare capacity - any incident pulls officers ($375M)', 'Evening shift chronic vacancies ($130M)', 'Officers skip breaks creating fatigue ($250M split across)'],
                    drivers: ['Zero-buffer operations', 'Vacancy rates', 'No relief coverage']
                },
                'Training & Readiness Gaps': {
                    cost: 290,
                    description: 'Insufficient academy throughput and officers working unfamiliar posts create inefficiencies and safety issues requiring additional supervisory support.',
                    painPoints: ['Short-staffed briefings missing critical info ($150M)', 'Unfamiliar post assignments requiring extra supervision ($140M)'],
                    drivers: ['Academy throughput', 'Training deficits', 'Post rotation issues']
                },
                'Oversight & Leakage': {
                    cost: 250,
                    description: 'Time leakage from officers arriving early or staying late (15 min increments rounded to 30 min) and inadequate tracking of actual hours worked.',
                    painPoints: ['Systematic time rounding and uncaptured hours ($250M)'],
                    drivers: ['Leakage (15 min early/late ‚Üí 30 min rounding)', 'Hours worked not captured on roster']
                }
            };

            const total = Object.values(categories).reduce((sum, cat) => sum + cat.cost, 0);

            const breakdownContent = document.getElementById('breakdownContent');
            
            let categoryHTML = '';
            Object.entries(categories).forEach(([name, data]) => {
                const percentage = ((data.cost / total) * 100).toFixed(1);
                const barWidth = percentage;
                
                categoryHTML += `
                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <span class="breakdown-category">${name}</span>
                            <span class="breakdown-value">$${data.cost}M</span>
                        </div>
                        <div class="breakdown-bar" style="width: ${barWidth}%">
                            <span class="breakdown-percentage">${percentage}%</span>
                        </div>
                        <div class="breakdown-description">${data.description}</div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-gray);">
                            <div style="font-size: 12px; font-weight: 700; color: var(--primary-blue); margin-bottom: 6px;">OPERATIONAL DRIVERS:</div>
                            <div style="font-size: 12px; color: var(--text-medium); margin-bottom: 8px;">${data.drivers.join(' ‚Ä¢ ')}</div>
                            <div style="font-size: 12px; font-weight: 700; color: var(--cost-red); margin-bottom: 6px;">SPECIFIC PAIN POINTS:</div>
                            <div style="font-size: 12px; color: var(--text-medium);">${data.painPoints.join(' ‚Ä¢ ')}</div>
                        </div>
                    </div>
                `;
            });

            breakdownContent.innerHTML = `
                <div class="summary-box">
                    <h3>Total Estimated Annual Overtime Cost</h3>
                    <div class="big-number">$${(total / 1000).toFixed(1)}B</div>
                    <div class="subtitle">Based on aggregated state-level data and national corrections personnel costs</div>
                </div>

                <h3 style="margin-bottom: 20px; color: var(--primary-blue);">Operational Hypothesis Categories</h3>
                ${categoryHTML}

                <div style="margin-top: 30px; padding: 20px; background: var(--light-blue); border-radius: 12px; border-left: 4px solid var(--primary-blue);">
                    <h4 style="color: var(--primary-blue); margin-bottom: 10px;">Methodology</h4>
                    <p style="font-size: 14px; line-height: 1.6; color: var(--text-dark); margin-bottom: 12px;">
                        Cost estimates are derived from reported overtime expenditures in multiple states including 
                        Illinois ($95.5M), Connecticut ($110.8M), Nebraska ($22M), Maryland ($150M), New York (significant 
                        portion of $1.3B state OT), California ($340M in 2015), and Georgia ($4M+). These figures were 
                        extrapolated nationally based on total correctional employment (~432,000 officers nationwide) and 
                        personnel costs representing 68% of total prison spending (~$43B).
                    </p>
                    <p style="font-size: 14px; line-height: 1.6; color: var(--text-dark);">
                        Pain points were mapped to operational categories based on root cause analysis from correctional 
                        research literature, DOJ Inspector General reports, corrections officer testimony, and operational 
                        hypothesis framework. Categories align with operational drivers identified through facility-level 
                        analysis of overtime triggers and staffing pattern compliance.
                    </p>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: #FEF3C7; border-radius: 12px; border-left: 4px solid #F59E0B;">
                    <h4 style="color: #92400E; margin-bottom: 10px;">üìä Key Insights</h4>
                    <ul style="font-size: 14px; line-height: 1.8; color: var(--text-dark); margin-left: 20px;">
                        <li><strong>Data & Tooling (24%)</strong> is the largest category, showing significant ROI opportunity in improving call-in systems and real-time visibility.</li>
                        <li><strong>Compliance (19%)</strong> suggests enforcing existing meta staffing patterns and fairness protocols could reduce nearly $500M in OT.</li>
                        <li><strong>Event Driven OT (17%)</strong> focuses specifically on incidents and operational failures that require emergency response‚Äîdistinct from structural capacity issues.</li>
                        <li><strong>Structural Understaffing (17%)</strong> represents the zero-buffer problem where facilities lack capacity to absorb ANY variation without triggering OT.</li>
                        <li><strong>Training Gaps (12%)</strong> indicates need for better academy throughput and post familiarization to reduce supervisory burden.</li>
                        <li><strong>Oversight & Leakage (10%)</strong> shows how time rounding and tracking gaps add up to significant waste.</li>
                    </ul>
                </div>
            `;

            // Navigate to breakdown view
            document.getElementById('workflowView').classList.remove('active');
            document.getElementById('breakdownView').classList.add('active');
            window.scrollTo(0, 0);
        }

        function showWorkflowView() {
            document.getElementById('breakdownView').classList.remove('active');
            document.getElementById('workflowView').classList.add('active');
            window.scrollTo(0, 0);
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${type === 'success' ? '‚úì' : '‚úï'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Wait for page to fully load before initializing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>